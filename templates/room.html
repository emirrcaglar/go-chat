{{template "layout" .}}
{{define "content"}}
    <div id="chat-window" style="border: 1px solid; height:300px; overflow-y: scroll; padding: 10px;">
        {{range .MessageHistory}}
            <p><small>{{.Username}}</small>: {{.Content}} <small>{{.Timestamp.Format "15:04"}}</small></p>
        {{end}}
    </div>
    <input type="text" id="message-input" placeholder="type a message">
    <button onclick="sendMessage()">Send</button>

<script>
    const roomID = "{{.Room.RoomIndex}}";
    const username = "{{.Username}}";
    console.log('roomID: ', roomID);
    console.log('username: ', username);
    
    const loc = window.location
    let ws_uri;
    if (loc.protocol == "https:"){
        ws_uri = "wss:";
    } else {
        ws_uri = "ws:";
    }
    ws_uri += "//" + loc.host + "/ws/room/" + roomID;
    const socket = new WebSocket(ws_uri);

    console.log('socket: ', socket.url);
    
    const chatWindow = document.getElementById('chat-window');
    const messageInput = document.getElementById('message-input');
    
    socket.onmessage = function(event) {
        const message = JSON.parse(event.data);
        const messageElement = document.createElement('p');
        
        const messageTime = new Date(message.timestamp);
        const hours = messageTime.getHours().toString().padStart(2, '0');
        const minutes = messageTime.getMinutes().toString().padStart(2, '0');
        const timeString = `${hours}:${minutes}`;

        messageElement.innerHTML = `<small>${message.username}</small>: ${message.content} <small>${timeString}</small>`;
        
        chatWindow.appendChild(messageElement);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    
    function sendMessage() {
        const content = messageInput.value;
        if (content.trim() == '') return;
        
        const message = {
            username: username,
            content: content,
            roomID: roomID
        }
        
        socket.send(JSON.stringify(message))
        messageInput.value = ''
    }
    
    messageInput.addEventListener('keypress', function(event){
        if (event.key == 'Enter'){
            sendMessage();
        }
    });
</script>
{{end}}